# Generated by Django 5.1.12 on 2025-11-29 11:13

import django.core.validators
import django.db.models.deletion
import uuid
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('django_celery_beat', '0019_alter_periodictasks_options'),
        ('service_integration', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='SMSConfigurationModel',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name_or_type', models.CharField(blank=True, max_length=255, null=True, unique=True)),
                ('tenant_id', models.UUIDField(blank=True, help_text='Tenant-specific configuration if set.', null=True)),
                ('endpoint_url', models.CharField(blank=True, max_length=255, null=True)),
                ('account_ssid', models.CharField(blank=True, max_length=255, null=True)),
                ('auth_token', models.CharField(blank=True, max_length=255, null=True)),
                ('verified_service_id', models.CharField(blank=True, max_length=255, null=True)),
                ('default_from_number', models.CharField(blank=True, help_text='Twilio phone number to use as sender (e.g. +15551234567)', max_length=20, null=True)),
                ('whatsapp_from_number', models.CharField(blank=True, help_text='WhatsApp Business number (e.g. whatsapp:+15551234567)', max_length=20, null=True)),
                ('whatsapp_enabled', models.BooleanField(default=False, help_text='Enable WhatsApp messaging for this configuration')),
            ],
            options={
                'verbose_name_plural': 'SMS/WhatsApp Configurations',
            },
        ),
        migrations.CreateModel(
            name='SMSTemplate',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('template_name', models.CharField(max_length=255, unique=True)),
                ('tenant_id', models.UUIDField(blank=True, help_text='Tenant-specific template if set.', null=True)),
                ('sms_body', models.CharField(help_text='Use {{variable_name}} for dynamic content.', max_length=160)),
                ('recipient_numbers_list', models.TextField(blank=True, help_text='Comma-separated phone numbers.')),
                ('supports_whatsapp', models.BooleanField(default=True, help_text='Whether this template can be used for WhatsApp')),
            ],
            options={
                'abstract': False,
            },
        ),
        migrations.CreateModel(
            name='EmailProvider',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(max_length=100)),
                ('provider_type', models.CharField(choices=[('AWS_SES', 'Amazon SES'), ('SENDGRID', 'SendGrid'), ('BREVO', 'Brevo (formerly Sendinblue)'), ('SMTP', 'Custom SMTP'), ('INTERNAL', 'Internal System')], max_length=20)),
                ('tenant_id', models.UUIDField(blank=True, db_index=True, help_text='If set, this is a tenant-specific provider. NULL means global provider.', null=True)),
                ('is_global', models.BooleanField(default=True, help_text='Whether this is a global provider (accessible by all tenants)')),
                ('encrypted_config', models.TextField(help_text='Encrypted provider-specific configuration')),
                ('max_emails_per_minute', models.PositiveIntegerField(default=100)),
                ('max_emails_per_hour', models.PositiveIntegerField(default=1000)),
                ('max_emails_per_day', models.PositiveIntegerField(default=10000)),
                ('is_default', models.BooleanField(default=False)),
                ('priority', models.PositiveIntegerField(default=1, help_text='Lower number = higher priority')),
                ('last_health_check', models.DateTimeField(blank=True, null=True)),
                ('health_status', models.CharField(choices=[('HEALTHY', 'Healthy'), ('DEGRADED', 'Degraded'), ('UNHEALTHY', 'Unhealthy'), ('UNKNOWN', 'Unknown')], default='UNKNOWN', max_length=20)),
                ('health_details', models.TextField(blank=True)),
                ('emails_sent_today', models.PositiveIntegerField(default=0)),
                ('emails_sent_this_hour', models.PositiveIntegerField(default=0)),
                ('last_used_at', models.DateTimeField(blank=True, null=True)),
            ],
            options={
                'verbose_name': 'Email Provider',
                'verbose_name_plural': 'Email Providers',
                'ordering': ['priority', 'name'],
                'indexes': [models.Index(fields=['tenant_id', 'is_global'], name='automation__tenant__45feb4_idx'), models.Index(fields=['is_global', 'is_default'], name='automation__is_glob_880012_idx')],
                'unique_together': {('name', 'tenant_id')},
            },
        ),
        migrations.CreateModel(
            name='AutomationRule',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('automation_name', models.CharField(max_length=100)),
                ('tenant_id', models.UUIDField(blank=True, db_index=True, help_text='Reference to tenant from tenant microservice (null for global rules)', null=True)),
                ('rule_scope', models.CharField(choices=[('TENANT', 'Tenant Specific'), ('GLOBAL', 'Global Organization')], default='TENANT', help_text='Whether this rule applies to a specific tenant or globally', max_length=10)),
                ('product_id', models.UUIDField(blank=True, db_index=True, help_text='Optional product ID for filtering', null=True)),
                ('reason_name', models.CharField(choices=[('TEST_TMD_INVITATION_SENT', 'Test TMD Invitation Sent'), ('TENANT_OTP_VERIFICATION', 'Tenant OTP Verification'), ('TENANT_REGISTRATION_CONFIRMATION', 'Tenant Registration Confirmation'), ('TENANT_SUBSCRIPTION_CONFIRMATION', 'Tenant Subscription Confirmation'), ('EMPLOYEE_WELCOME_EMAIL', 'Employee Welcome Email'), ('CANDIDATE_EMAIL_VERIFICATION', 'Candidate Email Verification'), ('INVITATION_SENT', 'Invitation Sent'), ('INVITATION_RESEND', 'Invitation Resend'), ('INVITATION_UPDATE', 'Invitation Update'), ('INVITATION_ACTIVATION', 'Invitation Activation'), ('INVITATION_DEACTIVATION', 'Invitation Deactivation'), ('PASSWORD_RESET', 'Password Reset'), ('ROLE_EXPIRATION_REMINDER', 'Role Expiration Reminder'), ('INVITATION_EXPIRATION_REMINDER', 'Invitation Expiration Reminder'), ('OTHER', 'Other')], max_length=100)),
                ('action_name', models.CharField(blank=True, max_length=100)),
                ('communication_type', models.CharField(choices=[('EMAIL', 'Email'), ('SMS', 'SMS'), ('WHATSAPP', 'WhatsApp'), ('PUSH', 'Push Notification')], default='EMAIL', max_length=10)),
                ('short_description', models.TextField(blank=True, help_text='A brief description of the automation rule.')),
                ('trigger_type', models.CharField(choices=[('IMMEDIATE', 'Immediate'), ('DELAY', 'Delay'), ('SCHEDULE', 'Schedule')], default='IMMEDIATE', max_length=20)),
                ('delay_amount', models.PositiveIntegerField(blank=True, help_text='Amount of time to delay. (e.g., 5, 10, 20)', null=True)),
                ('delay_unit', models.CharField(blank=True, choices=[('SECONDS', 'Seconds'), ('MINUTES', 'Minutes'), ('HOURS', 'Hours'), ('DAYS', 'Days')], help_text='Unit of time for the delay (e.g., SECONDS, MINUTES, etc.).', max_length=20, null=True)),
                ('schedule_frequency', models.CharField(blank=True, choices=[('INTERVAL', 'Interval'), ('DAILY', 'Daily'), ('WEEKLY', 'Weekly'), ('MONTHLY', 'Monthly')], help_text='Frequency of the schedule (e.g., INTERVAL, DAILY, WEEKLY, MONTHLY).', max_length=20, null=True)),
                ('schedule_interval_amount', models.PositiveIntegerField(blank=True, help_text="e.g., every '5' minutes", null=True)),
                ('schedule_interval_unit', models.CharField(blank=True, choices=[('SECONDS', 'Seconds'), ('MINUTES', 'Minutes'), ('HOURS', 'Hours'), ('DAYS', 'Days')], help_text="e.g., every 5 'minutes'", max_length=20, null=True)),
                ('schedule_time', models.TimeField(blank=True, help_text='Time of day to send (UTC). e.g., 2:30 PM UTC', null=True)),
                ('schedule_day_of_week', models.PositiveIntegerField(blank=True, help_text='1=Monday, 7=Sunday', null=True)),
                ('schedule_day_of_month', models.PositiveIntegerField(blank=True, help_text='1-31', null=True)),
                ('max_retries', models.PositiveIntegerField(default=3)),
                ('retry_delay_minutes', models.PositiveIntegerField(default=5)),
                ('batch_size', models.PositiveIntegerField(default=1, help_text='Number of emails to process in one batch')),
                ('filter_conditions', models.JSONField(blank=True, help_text="JSON conditions for advanced filtering. Example: {'user_status': 'active', 'plan_type': ['premium', 'enterprise']}", null=True)),
                ('priority', models.PositiveIntegerField(default=5, help_text='1=highest priority, 10=lowest priority')),
                ('periodic_task', models.OneToOneField(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='django_celery_beat.periodictask')),
                ('preferred_global_provider', models.ForeignKey(blank=True, help_text='Global provider (for global rules or direct provider selection)', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='automation_rules_using', to='automation_rule.emailprovider')),
            ],
            options={
                'verbose_name': 'Automation Rule',
                'verbose_name_plural': 'Automation Rules',
            },
        ),
        migrations.CreateModel(
            name='EmailQueue',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('tenant_id', models.UUIDField(blank=True, db_index=True, help_text='Reference to tenant from tenant microservice (null for global emails)', null=True)),
                ('recipient_email', models.EmailField(db_index=True, max_length=254)),
                ('subject', models.CharField(max_length=255)),
                ('html_content', models.TextField()),
                ('text_content', models.TextField(blank=True)),
                ('context_data', models.JSONField(blank=True, help_text='Template variables and context', null=True)),
                ('headers', models.JSONField(blank=True, help_text='Custom email headers', null=True)),
                ('status', models.CharField(choices=[('PENDING', 'Pending'), ('PROCESSING', 'Processing'), ('SENT', 'Sent'), ('FAILED', 'Failed'), ('CANCELLED', 'Cancelled'), ('RETRYING', 'Retrying')], db_index=True, default='PENDING', max_length=20)),
                ('priority', models.PositiveIntegerField(default=5, help_text='1=highest, 10=lowest')),
                ('scheduled_at', models.DateTimeField(db_index=True)),
                ('processed_at', models.DateTimeField(blank=True, null=True)),
                ('retry_count', models.PositiveIntegerField(default=0)),
                ('max_retries', models.PositiveIntegerField(default=3)),
                ('next_retry_at', models.DateTimeField(blank=True, null=True)),
                ('error_message', models.TextField(blank=True)),
                ('error_code', models.CharField(blank=True, max_length=50)),
                ('assigned_provider', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='automation_rule.emailprovider')),
                ('automation_rule', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='queued_emails', to='automation_rule.automationrule')),
            ],
            options={
                'verbose_name': 'Email Queue Item',
                'verbose_name_plural': 'Email Queue',
                'ordering': ['priority', 'scheduled_at'],
            },
        ),
        migrations.CreateModel(
            name='EmailTemplate',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('template_name', models.CharField(max_length=255)),
                ('tenant_id', models.UUIDField(blank=True, help_text='Tenant-specific template if set (null for global templates).', null=True)),
                ('template_type', models.CharField(choices=[('TENANT', 'Tenant Specific'), ('GLOBAL', 'Global Organization')], default='TENANT', help_text='Whether this template is global or tenant-specific', max_length=100)),
                ('category', models.CharField(choices=[('TEST_TMD_INVITATION_SENT', 'Test TMD Invitation Sent'), ('TENANT_OTP_VERIFICATION', 'Tenant OTP Verification'), ('TENANT_REGISTRATION_CONFIRMATION', 'Tenant Registration Confirmation'), ('TENANT_SUBSCRIPTION_CONFIRMATION', 'Tenant Subscription Confirmation'), ('EMPLOYEE_WELCOME_EMAIL', 'Employee Welcome Email'), ('CANDIDATE_EMAIL_VERIFICATION', 'Candidate Email Verification'), ('INVITATION_SENT', 'Invitation Sent'), ('INVITATION_RESEND', 'Invitation Resend'), ('INVITATION_UPDATE', 'Invitation Update'), ('INVITATION_ACTIVATION', 'Invitation Activation'), ('INVITATION_DEACTIVATION', 'Invitation Deactivation'), ('PASSWORD_RESET', 'Password Reset'), ('ROLE_EXPIRATION_REMINDER', 'Role Expiration Reminder'), ('INVITATION_EXPIRATION_REMINDER', 'Invitation Expiration Reminder'), ('OTHER', 'Other')], default='OTHER', help_text='Template category for organization', max_length=100)),
                ('email_subject', models.CharField(max_length=255)),
                ('email_body', models.TextField(help_text='Use {{variable_name}} for dynamic content.')),
                ('recipient_emails_list', models.TextField(blank=True, help_text='Comma-separated email addresses.')),
            ],
            options={
                'abstract': False,
                'constraints': [models.UniqueConstraint(condition=models.Q(('tenant_id__isnull', False)), fields=('template_name', 'tenant_id'), name='unique_template_per_tenant'), models.UniqueConstraint(condition=models.Q(('tenant_id__isnull', True)), fields=('template_name',), name='unique_global_template')],
            },
        ),
        migrations.AddField(
            model_name='automationrule',
            name='email_template_id',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='automation_rule.emailtemplate'),
        ),
        migrations.CreateModel(
            name='EmailValidation',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('email_address', models.EmailField(db_index=True, max_length=254, unique=True, validators=[django.core.validators.EmailValidator()])),
                ('is_valid_format', models.BooleanField(default=True)),
                ('is_disposable', models.BooleanField(default=False)),
                ('is_role_based', models.BooleanField(default=False, help_text='info@, admin@, support@, etc.')),
                ('domain_mx_valid', models.BooleanField(default=True)),
                ('validation_status', models.CharField(choices=[('VALID', 'Valid'), ('INVALID', 'Invalid'), ('RISKY', 'Risky'), ('UNKNOWN', 'Unknown')], default='UNKNOWN', max_length=10)),
                ('validation_score', models.FloatField(blank=True, help_text='Validation score 0-100', null=True)),
                ('bounce_count', models.PositiveIntegerField(default=0)),
                ('complaint_count', models.PositiveIntegerField(default=0)),
                ('successful_deliveries', models.PositiveIntegerField(default=0)),
                ('is_blacklisted', models.BooleanField(default=False)),
                ('blacklist_reason', models.TextField(blank=True)),
                ('blacklisted_at', models.DateTimeField(blank=True, null=True)),
                ('last_validated_at', models.DateTimeField(auto_now=True)),
                ('validation_provider', models.CharField(blank=True, help_text='Service used for validation', max_length=50)),
            ],
            options={
                'verbose_name': 'Email Validation',
                'verbose_name_plural': 'Email Validations',
                'indexes': [models.Index(fields=['email_address'], name='automation__email_a_a4ac9b_idx'), models.Index(fields=['validation_status', 'is_blacklisted'], name='automation__validat_6c3dad_idx'), models.Index(fields=['is_blacklisted', 'last_validated_at'], name='automation__is_blac_5d7e42_idx')],
            },
        ),
        migrations.CreateModel(
            name='EmailDeliveryLog',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('tenant_id', models.UUIDField(blank=True, db_index=True, help_text='Reference to tenant from tenant microservice', null=True)),
                ('product_id', models.UUIDField(blank=True, db_index=True, help_text='Associated product for this dispatch', null=True)),
                ('reason_name', models.CharField(blank=True, help_text='Snapshot of automation reason at send time', max_length=100)),
                ('trigger_type', models.CharField(blank=True, help_text='Snapshot of trigger type at send time', max_length=20)),
                ('provider_message_id', models.CharField(blank=True, db_index=True, max_length=255)),
                ('recipient_email', models.EmailField(db_index=True, max_length=254)),
                ('sender_email', models.EmailField(blank=True, max_length=254)),
                ('subject', models.CharField(blank=True, max_length=255)),
                ('delivery_status', models.CharField(choices=[('QUEUED', 'Queued'), ('SENT', 'Sent'), ('DELIVERED', 'Delivered'), ('BOUNCED', 'Bounced'), ('COMPLAINED', 'Complained'), ('OPENED', 'Opened'), ('CLICKED', 'Clicked'), ('UNSUBSCRIBED', 'Unsubscribed'), ('FAILED', 'Failed')], db_index=True, max_length=20)),
                ('log_scope', models.CharField(choices=[('TENANT', 'Tenant'), ('GLOBAL', 'Global')], db_index=True, default='TENANT', max_length=10)),
                ('sent_at', models.DateTimeField(auto_now_add=True)),
                ('delivered_at', models.DateTimeField(blank=True, null=True)),
                ('opened_at', models.DateTimeField(blank=True, null=True)),
                ('clicked_at', models.DateTimeField(blank=True, null=True)),
                ('bounced_at', models.DateTimeField(blank=True, null=True)),
                ('planned_delivery_at', models.DateTimeField(blank=True, null=True)),
                ('open_count', models.PositiveIntegerField(default=0)),
                ('click_count', models.PositiveIntegerField(default=0)),
                ('unique_click_count', models.PositiveIntegerField(default=0)),
                ('bounce_type', models.CharField(blank=True, choices=[('HARD', 'Hard Bounce'), ('SOFT', 'Soft Bounce'), ('COMPLAINT', 'Complaint')], max_length=20)),
                ('bounce_reason', models.TextField(blank=True)),
                ('spam_score', models.FloatField(blank=True, null=True)),
                ('is_spam', models.BooleanField(default=False)),
                ('is_duplicate', models.BooleanField(default=False)),
                ('user_agent', models.TextField(blank=True, help_text='User agent for opens/clicks')),
                ('ip_address', models.GenericIPAddressField(blank=True, null=True)),
                ('event_history', models.JSONField(blank=True, default=list, help_text='Chronological list of provider events')),
                ('context_data', models.JSONField(blank=True, default=dict, help_text='Template variables used for rendering', null=True)),
                ('error_message', models.TextField(blank=True, help_text='Error information for failed sends')),
                ('automation_rule', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='automation_rule.automationrule')),
                ('duplicate_of', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='duplicates', to='automation_rule.emaildeliverylog')),
                ('email_provider', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='automation_rule.emailprovider')),
                ('queue_item', models.OneToOneField(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='delivery_log', to='automation_rule.emailqueue')),
                ('email_template', models.ForeignKey(blank=True, help_text='Email template used when rendering the message', null=True, on_delete=django.db.models.deletion.SET_NULL, to='automation_rule.emailtemplate')),
                ('email_validation', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='automation_rule.emailvalidation')),
            ],
            options={
                'verbose_name': 'Email Delivery Log',
                'verbose_name_plural': 'Email Delivery Logs',
            },
        ),
        migrations.AddField(
            model_name='automationrule',
            name='sms_config_id',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='automation_rule.smsconfigurationmodel'),
        ),
        migrations.AddField(
            model_name='automationrule',
            name='sms_template_id',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='automation_rule.smstemplate'),
        ),
        migrations.CreateModel(
            name='TenantEmailConfiguration',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('tenant_id', models.UUIDField(db_index=True, help_text='Reference to tenant from tenant microservice', unique=True)),
                ('plan_type', models.CharField(choices=[('FREE', 'Free'), ('BASIC', 'Basic'), ('PROFESSIONAL', 'Professional'), ('ENTERPRISE', 'Enterprise')], default='FREE', max_length=20)),
                ('emails_per_day', models.PositiveIntegerField(default=100)),
                ('emails_per_month', models.PositiveIntegerField(default=1000)),
                ('emails_per_minute', models.PositiveIntegerField(default=10)),
                ('custom_domain_allowed', models.BooleanField(default=False)),
                ('advanced_analytics', models.BooleanField(default=False)),
                ('priority_support', models.BooleanField(default=False)),
                ('bulk_email_allowed', models.BooleanField(default=False)),
                ('default_from_domain', models.CharField(blank=True, max_length=255, null=True)),
                ('custom_domain', models.CharField(blank=True, max_length=255, null=True)),
                ('custom_domain_verified', models.BooleanField(default=False)),
                ('domain_verification_token', models.CharField(blank=True, max_length=255)),
                ('emails_sent_today', models.PositiveIntegerField(default=0)),
                ('emails_sent_this_month', models.PositiveIntegerField(default=0)),
                ('last_email_sent_at', models.DateTimeField(blank=True, null=True)),
                ('last_daily_reset', models.DateField(blank=True, null=True)),
                ('last_monthly_reset', models.DateField(blank=True, null=True)),
                ('is_suspended', models.BooleanField(default=False)),
                ('suspension_reason', models.TextField(blank=True)),
                ('suspended_at', models.DateTimeField(blank=True, null=True)),
                ('bounce_rate', models.FloatField(default=0.0, help_text='Bounce rate percentage')),
                ('complaint_rate', models.FloatField(default=0.0, help_text='Complaint rate percentage')),
                ('reputation_score', models.FloatField(default=100.0, help_text='Email reputation score (0-100)')),
            ],
            options={
                'verbose_name': 'Tenant Email Configuration',
                'verbose_name_plural': 'Tenant Email Configurations',
                'indexes': [models.Index(fields=['tenant_id'], name='automation__tenant__05cfe3_idx'), models.Index(fields=['plan_type', 'activated_by_tmd'], name='automation__plan_ty_c09e0e_idx')],
            },
        ),
        migrations.AddField(
            model_name='automationrule',
            name='tenant_email_config',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='automation_rule.tenantemailconfiguration'),
        ),
        migrations.CreateModel(
            name='TenantEmailProvider',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('tenant_id', models.UUIDField(db_index=True, help_text='Reference to tenant from tenant microservice')),
                ('is_enabled', models.BooleanField(default=True)),
                ('is_primary', models.BooleanField(default=False, help_text='Primary provider for this tenant')),
                ('custom_encrypted_config', models.TextField(blank=True, help_text='Tenant-specific config overrides')),
                ('custom_max_emails_per_minute', models.PositiveIntegerField(blank=True, null=True)),
                ('custom_max_emails_per_hour', models.PositiveIntegerField(blank=True, null=True)),
                ('custom_max_emails_per_day', models.PositiveIntegerField(blank=True, null=True)),
                ('emails_sent_today', models.PositiveIntegerField(default=0)),
                ('emails_sent_this_hour', models.PositiveIntegerField(default=0)),
                ('last_used_at', models.DateTimeField(blank=True, null=True)),
                ('bounce_rate', models.FloatField(default=0.0)),
                ('complaint_rate', models.FloatField(default=0.0)),
                ('delivery_rate', models.FloatField(default=100.0)),
                ('provider', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tenant_configs', to='automation_rule.emailprovider')),
            ],
            options={
                'verbose_name': 'Tenant Email Provider',
                'verbose_name_plural': 'Tenant Email Providers',
            },
        ),
        migrations.AddField(
            model_name='automationrule',
            name='preferred_email_provider',
            field=models.ForeignKey(blank=True, help_text='Tenant-specific provider configuration (for tenant-scoped rules)', null=True, on_delete=django.db.models.deletion.SET_NULL, to='automation_rule.tenantemailprovider'),
        ),
        migrations.CreateModel(
            name='TenantServiceDefinition',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('account_name', models.CharField(help_text="Name for this tenant's service integration", max_length=255)),
                ('is_verified', models.BooleanField(default=False)),
                ('verification_token', models.CharField(blank=True, max_length=255, null=True)),
                ('verified_at', models.DateTimeField(blank=True, null=True)),
                ('last_used_at', models.DateTimeField(blank=True, null=True)),
                ('usage_count', models.PositiveIntegerField(default=0)),
                ('service_integration', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tenant_integrations', to='service_integration.servicedefinition')),
                ('tenant_email_provider', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='service_integrations', to='automation_rule.tenantemailprovider')),
            ],
            options={
                'verbose_name': 'Tenant Service Integration',
                'verbose_name_plural': 'Tenant Service Integrations',
                'db_table': 'tenant_service_integration',
            },
        ),
        migrations.CreateModel(
            name='EmailAction',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('action_type', models.CharField(choices=[('RESEND', 'Resend'), ('FORWARD', 'Forward'), ('CANCEL', 'Cancel'), ('ARCHIVE', 'Archive'), ('SUPPRESS', 'Suppress')], max_length=20)),
                ('new_recipient', models.EmailField(blank=True, max_length=254, null=True)),
                ('reason', models.TextField(blank=True)),
                ('performed_by', models.UUIDField(blank=True, help_text='User ID who performed the action', null=True)),
                ('performed_at', models.DateTimeField(auto_now_add=True)),
                ('new_delivery_log', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='source_actions', to='automation_rule.emaildeliverylog')),
                ('original_log', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='actions', to='automation_rule.emaildeliverylog')),
            ],
            options={
                'verbose_name': 'Email Action',
                'verbose_name_plural': 'Email Actions',
                'indexes': [models.Index(fields=['original_log', 'action_type'], name='automation__origina_76a647_idx'), models.Index(fields=['performed_at', 'action_type'], name='automation__perform_daf57b_idx')],
            },
        ),
        migrations.CreateModel(
            name='EmailProviderServiceDefinition',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.UUIDField(blank=True, null=True)),
                ('updated_by', models.UUIDField(blank=True, null=True)),
                ('activated_by_td', models.BooleanField(default=False)),
                ('activated_by_tmd', models.BooleanField(default=False)),
                ('activated_by_root', models.BooleanField(default=True)),
                ('is_deleted', models.BooleanField(default=False)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('webhook_url', models.URLField(blank=True, help_text='Webhook URL for provider events', null=True)),
                ('callback_secret', models.CharField(blank=True, max_length=255, null=True)),
                ('last_sync_at', models.DateTimeField(blank=True, null=True)),
                ('sync_status', models.CharField(choices=[('SYNCED', 'Synced'), ('PENDING', 'Pending'), ('ERROR', 'Error'), ('DISABLED', 'Disabled')], default='PENDING', max_length=20)),
                ('sync_error_message', models.TextField(blank=True, null=True)),
                ('email_provider', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='service_integration', to='automation_rule.emailprovider')),
                ('service_integration', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='email_provider_integrations', to='service_integration.servicedefinition')),
            ],
            options={
                'verbose_name': 'Email Provider Service Integration',
                'verbose_name_plural': 'Email Provider Service Integrations',
                'db_table': 'email_provider_service_integration',
                'indexes': [models.Index(fields=['service_integration', 'email_provider'], name='email_provi_service_8953dd_idx'), models.Index(fields=['sync_status'], name='email_provi_sync_st_6f51cd_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='emailqueue',
            index=models.Index(fields=['status', 'scheduled_at'], name='automation__status_f86606_idx'),
        ),
        migrations.AddIndex(
            model_name='emailqueue',
            index=models.Index(fields=['tenant_id', 'status'], name='automation__tenant__b13bb4_idx'),
        ),
        migrations.AddIndex(
            model_name='emailqueue',
            index=models.Index(fields=['tenant_id', 'automation_rule', 'status'], name='automation__tenant__d38e12_idx'),
        ),
        migrations.AddIndex(
            model_name='emailqueue',
            index=models.Index(fields=['scheduled_at', 'priority'], name='automation__schedul_3f5e0a_idx'),
        ),
        migrations.AddIndex(
            model_name='emaildeliverylog',
            index=models.Index(fields=['tenant_id', 'delivery_status'], name='automation__tenant__d2c42f_idx'),
        ),
        migrations.AddIndex(
            model_name='emaildeliverylog',
            index=models.Index(fields=['tenant_id', 'sent_at'], name='automation__tenant__577e43_idx'),
        ),
        migrations.AddIndex(
            model_name='emaildeliverylog',
            index=models.Index(fields=['recipient_email', 'sent_at'], name='automation__recipie_614cee_idx'),
        ),
        migrations.AddIndex(
            model_name='emaildeliverylog',
            index=models.Index(fields=['automation_rule', 'sent_at'], name='automation__automat_812e56_idx'),
        ),
        migrations.AddIndex(
            model_name='emaildeliverylog',
            index=models.Index(fields=['delivery_status', 'sent_at'], name='automation__deliver_f727ec_idx'),
        ),
        migrations.AddIndex(
            model_name='emaildeliverylog',
            index=models.Index(fields=['provider_message_id'], name='automation__provide_b7b792_idx'),
        ),
        migrations.AddIndex(
            model_name='emaildeliverylog',
            index=models.Index(fields=['log_scope', 'sent_at'], name='automation__log_sco_e0057c_idx'),
        ),
        migrations.AddIndex(
            model_name='emaildeliverylog',
            index=models.Index(fields=['product_id', 'sent_at'], name='automation__product_3eea1c_idx'),
        ),
        migrations.AddIndex(
            model_name='emaildeliverylog',
            index=models.Index(fields=['email_template', 'sent_at'], name='automation__email_t_acf8a8_idx'),
        ),
        migrations.AddIndex(
            model_name='tenantemailprovider',
            index=models.Index(fields=['tenant_id', 'is_enabled'], name='automation__tenant__e29db8_idx'),
        ),
        migrations.AddIndex(
            model_name='tenantemailprovider',
            index=models.Index(fields=['tenant_id', 'is_primary'], name='automation__tenant__090c0d_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='tenantemailprovider',
            unique_together={('tenant_id', 'provider')},
        ),
        migrations.AddIndex(
            model_name='automationrule',
            index=models.Index(fields=['tenant_id', 'activated_by_tmd'], name='automation__tenant__a28bbc_idx'),
        ),
        migrations.AddIndex(
            model_name='automationrule',
            index=models.Index(fields=['rule_scope', 'activated_by_tmd'], name='automation__rule_sc_df2e89_idx'),
        ),
        migrations.AddIndex(
            model_name='automationrule',
            index=models.Index(fields=['reason_name', 'communication_type'], name='automation__reason__4cc273_idx'),
        ),
        migrations.AddIndex(
            model_name='automationrule',
            index=models.Index(fields=['product_id', 'activated_by_tmd'], name='automation__product_501160_idx'),
        ),
        migrations.AddIndex(
            model_name='automationrule',
            index=models.Index(fields=['trigger_type', 'activated_by_tmd'], name='automation__trigger_f10744_idx'),
        ),
        migrations.AddConstraint(
            model_name='automationrule',
            constraint=models.UniqueConstraint(condition=models.Q(('is_deleted', False), ('rule_scope', 'TENANT')), fields=('tenant_id', 'reason_name', 'communication_type'), name='unique_tenant_automation_rule'),
        ),
        migrations.AddConstraint(
            model_name='automationrule',
            constraint=models.UniqueConstraint(condition=models.Q(('is_deleted', False), ('rule_scope', 'GLOBAL')), fields=('reason_name', 'communication_type'), name='unique_global_automation_rule'),
        ),
        migrations.AddIndex(
            model_name='tenantservicedefinition',
            index=models.Index(fields=['tenant_email_provider', 'is_verified'], name='tenant_serv_tenant__b8cc78_idx'),
        ),
        migrations.AddIndex(
            model_name='tenantservicedefinition',
            index=models.Index(fields=['last_used_at'], name='tenant_serv_last_us_01e4ed_idx'),
        ),
        migrations.AddIndex(
            model_name='tenantservicedefinition',
            index=models.Index(fields=['service_integration'], name='tenant_serv_service_f09dae_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='tenantservicedefinition',
            unique_together={('service_integration', 'tenant_email_provider')},
        ),
    ]
