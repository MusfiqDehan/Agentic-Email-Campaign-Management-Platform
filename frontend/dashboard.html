<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Email Campaign Platform</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                EmailCampaign
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" id="menu-providers" onclick="showSection('providers')">Email Providers</a></li>
                <li><a href="#" id="menu-templates" onclick="showSection('templates')">Email Templates</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div id="providers-section" style="display: none;">
                <div class="content-header">
                    <h2>Email Providers</h2>
                    <button class="btn-primary" onclick="openModal('providerModal')">Add Provider</button>
                </div>
                <div class="card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody id="providers-list">
                            <!-- Providers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="templates-section" style="display: none;">
                <div class="content-header">
                    <h2>Email Templates</h2>
                    <button class="btn-primary" onclick="openModal('templateModal')">Add Template</button>
                </div>
                <div class="card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Subject</th>
                                <th>Category</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody id="templates-list">
                            <!-- Templates will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Provider Modal -->
    <div id="providerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Email Provider</h3>
                <span class="close-modal" onclick="closeModal('providerModal')">&times;</span>
            </div>
            <div id="provider-alert" class="alert"></div>
            <form id="providerForm">
                <div class="form-group">
                    <label for="providerName">Name</label>
                    <input type="text" id="providerName" required>
                </div>
                <div class="form-group">
                    <label for="providerType">Type</label>
                    <select id="providerType" required>
                        <option value="SMTP">SMTP</option>
                        <option value="SES">Amazon SES</option>
                        <option value="SENDGRID">SendGrid</option>
                        <option value="MAILGUN">Mailgun</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="providerConfig">Configuration (JSON)</label>
                    <textarea id="providerConfig" rows="5" required placeholder='{"host": "smtp.example.com", "port": 587, "username": "user", "password": "pass"}'></textarea>
                </div>
                <button type="submit" class="btn-primary btn-block">Add Provider</button>
            </form>
        </div>
    </div>

    <!-- Add Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Email Template</h3>
                <span class="close-modal" onclick="closeModal('templateModal')">&times;</span>
            </div>
            <div id="template-alert" class="alert"></div>
            <form id="templateForm">
                <div class="form-group">
                    <label for="templateName">Template Name</label>
                    <input type="text" id="templateName" required>
                </div>
                <div class="form-group">
                    <label for="templateSubject">Subject</label>
                    <input type="text" id="templateSubject" required>
                </div>
                <div class="form-group">
                    <label for="templateBody">HTML Content</label>
                    <textarea id="templateBody" rows="5" required></textarea>
                </div>
                <button type="submit" class="btn-primary btn-block">Add Template</button>
            </form>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Check auth on load
        checkAuth();

        // Navigation
        function showSection(sectionId) {
            document.getElementById('providers-section').style.display = 'none';
            document.getElementById('templates-section').style.display = 'none';
            document.getElementById('menu-providers').classList.remove('active');
            document.getElementById('menu-templates').classList.remove('active');

            document.getElementById(`${sectionId}-section`).style.display = 'block';
            document.getElementById(`menu-${sectionId}`).classList.add('active');

            if (sectionId === 'providers') loadProvidersList();
            if (sectionId === 'templates') loadTemplatesList();
        }

        // Modals
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Providers Logic
        async function loadProvidersList() {
            const tbody = document.getElementById('providers-list');
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
            try {
                const data = await getProviders();
                const providers = data.data.results || data.data || []; // Adjust based on pagination response
                
                if (providers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No providers found.</td></tr>';
                    return;
                }

                tbody.innerHTML = providers.map(p => `
                    <tr>
                        <td>${p.name}</td>
                        <td>${p.provider_type}</td>
                        <td>${p.health_status || 'Unknown'}</td>
                        <td>${new Date(p.created_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="4" style="color: red;">Error: ${error.message}</td></tr>`;
            }
        }

        document.getElementById('providerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('providerName').value;
            const type = document.getElementById('providerType').value;
            const configStr = document.getElementById('providerConfig').value;
            
            try {
                let config;
                try {
                    config = JSON.parse(configStr);
                } catch (err) {
                    throw new Error('Invalid JSON configuration');
                }

                await createProvider({
                    name: name,
                    provider_type: type,
                    config: config
                });
                
                closeModal('providerModal');
                e.target.reset();
                loadProvidersList();
            } catch (error) {
                showAlert('provider-alert', error.message, 'danger');
            }
        });

        // Templates Logic
        async function loadTemplatesList() {
            const tbody = document.getElementById('templates-list');
            tbody.innerHTML = '<tr><td colspan="4">Loading...</td></tr>';
            try {
                const data = await getTemplates();
                const templates = data.data.results || data.data || [];
                
                if (templates.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No templates found.</td></tr>';
                    return;
                }

                tbody.innerHTML = templates.map(t => `
                    <tr>
                        <td>${t.template_name}</td>
                        <td>${t.email_subject}</td>
                        <td>${t.category}</td>
                        <td>${new Date(t.created_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="4" style="color: red;">Error: ${error.message}</td></tr>`;
            }
        }

        document.getElementById('templateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('templateName').value;
            const subject = document.getElementById('templateSubject').value;
            const body = document.getElementById('templateBody').value;
            
            try {
                await createTemplate({
                    template_name: name,
                    email_subject: subject,
                    email_body: body
                });
                
                closeModal('templateModal');
                e.target.reset();
                loadTemplatesList();
            } catch (error) {
                showAlert('template-alert', error.message, 'danger');
            }
        });

        // Initial load
        showSection('providers');
    </script>
</body>
</html>
